# Claude Code 자동 메모리 (Auto Memory) 상세 가이드

## 핵심 요약

v2.1.32의 "Auto Memory"는 단일 기능이 아니라 **3가지 메커니즘의 결합**입니다:

┌───────────────────────┬──────────────────────────────────────────────┬─────────────┐
│       메커니즘        │                     설명                     │ 사용자 개입 │
├───────────────────────┼──────────────────────────────────────────────┼─────────────┤
│ Session Memory        │ 세션 중 자동으로 작업 요약을 기록/회상       │ 불필요      │
├───────────────────────┼──────────────────────────────────────────────┼─────────────┤
│ Auto Memory Directory │ MEMORY.md 파일을 시스템 프롬프트에 자동 로드 │ 선택적      │
├───────────────────────┼──────────────────────────────────────────────┼─────────────┤
│ CLAUDE.md 계층        │ 프로젝트/사용자별 영구 지시사항              │ 수동 관리   │
└───────────────────────┴──────────────────────────────────────────────┴─────────────┘

---

## 1. Session Memory (핵심 자동 기능)

### 작동 방식

#### 기록 (Recording)

- 백그라운드 프로세스가 대화를 지속 모니터링
- 대화 전체를 저장하는 것이 아니라, **핵심 정보를 마크다운 요약으로 압축**
- 추출 타이밍:
  - 최초: 대화가 약 **10,000 토큰**에 도달 시
  - 이후 갱신: 약 **5,000 토큰**마다 또는 **3회 도구 호출**마다
- 터미널에 `"Wrote X memories"` 메시지가 주기적으로 표시

#### 회상 (Recalling)

- 새 세션 시작 시 과거 세션 요약이 자동으로 컨텍스트에 주입
- 터미널에 `"Recalled X memories"` 표시 (Ctrl+O로 상세 확인)
- "이전 세션에서 가져온 것으로 현재와 관련 없을 수 있음"이라는 주석이 함께 주입되어, 맹목적 추종 방지

#### 저장 경로

```
~/.claude/projects/<project-path-encoded>/<session-id>/session-memory/summary.md
```

---

## 2. Auto Memory Directory

### 작동 방식

```
~/.claude/projects/<project-path-encoded>/memory/MEMORY.md
```

- 이 경로에 `MEMORY.md`를 넣으면 매 세션 시스템 프롬프트에 자동 로드
- Claude가 작업 중 이 디렉토리에 자동으로 파일을 기록할 수도 있음
- **200줄 제한** — 초과 시 잘림, 상세 내용은 같은 디렉토리 내 다른 파일로 분리 권장

**주의**: 이 기능은 아직 공식 문서에 정식 등재되지 않은 **미문서화 내장 기능**입니다.

---

## 3. CLAUDE.md 계층적 메모리 (명시적 메모리)

### 우선순위 (높음 → 낮음)

```
관리형 정책 (Managed)          ← 조직 IT 관리자
  └─ CLAUDE.local.md          ← 개인, 현재 프로젝트 (gitignore)
      └─ CLAUDE.md            ← 팀 공유, 프로젝트 단위
          └─ ~/.claude/CLAUDE.md  ← 개인, 전체 프로젝트
```

### 파일 위치 정리

┌────────────────────────────┬───────────────────────────┬───────────────────────┐
│            파일            │           범위            │         공유          │
├────────────────────────────┼───────────────────────────┼───────────────────────┤
│ /etc/claude-code/CLAUDE.md │ 조직 전체 (Linux)         │ 관리형                │
├────────────────────────────┼───────────────────────────┼───────────────────────┤
│ ~/.claude/CLAUDE.md        │ 본인 전체 프로젝트        │ 개인                  │
├────────────────────────────┼───────────────────────────┼───────────────────────┤
│ ~/.claude/rules/*.md       │ 본인 전체 프로젝트 (규칙) │ 개인                  │
├────────────────────────────┼───────────────────────────┼───────────────────────┤
│ ./CLAUDE.md                │ 현재 프로젝트             │ 팀 (git 추적)         │
├────────────────────────────┼───────────────────────────┼───────────────────────┤
│ ./.claude/rules/*.md       │ 현재 프로젝트 (규칙)      │ 팀 (git 추적)         │
├────────────────────────────┼───────────────────────────┼───────────────────────┤
│ ./CLAUDE.local.md          │ 현재 프로젝트             │ 개인 (자동 gitignore) │
└────────────────────────────┴───────────────────────────┴───────────────────────┘

---

## 4. Auto Memory vs /remember 비교

┌─────────────┬──────────────────────────────┬────────────────────────────────┐
│    항목     │ Auto Memory (Session Memory) │           /remember            │
├─────────────┼──────────────────────────────┼────────────────────────────────┤
│ 생성 주체   │ Claude (자동, 백그라운드)    │ 사용자 (명시적 트리거)         │
├─────────────┼──────────────────────────────┼────────────────────────────────┤
│ 저장 위치   │ session-memory/summary.md    │ CLAUDE.local.md                │
├─────────────┼──────────────────────────────┼────────────────────────────────┤
│ 내용        │ 세션별 작업 요약 스냅샷      │ 반복 패턴에서 추출한 영구 규칙 │
├─────────────┼──────────────────────────────┼────────────────────────────────┤
│ 수명        │ 세션별 축적                  │ 파일 삭제 전까지 영구          │
├─────────────┼──────────────────────────────┼────────────────────────────────┤
│ 우선순위    │ 낮음 (백그라운드 참조)       │ 높음 (CLAUDE.local.md)         │
├─────────────┼──────────────────────────────┼────────────────────────────────┤
│ 사용자 개입 │ 불필요                       │ 각 항목 확인 필요              │
└─────────────┴──────────────────────────────┴────────────────────────────────┘

### 핵심 관계

**`/remember`는 Session Memory → CLAUDE.local.md로의 승격 브릿지입니다.**

예를 들어 "3개 세션 연속으로 같은 포매팅 규칙을 수정했다"는 패턴을 감지하면, 이를 영구 규칙으로 승격 제안합니다.

---

## 5. v2.1.33 Memory Frontmatter (에이전트용)

에이전트/스킬 정의 파일에서 메모리 스코프를 선언적으로 지정:

```markdown
---
name: my-security-agent
memory: project     # user | project | local
---

보안 감사를 수행하는 에이전트입니다...
```

┌─────────┬────────────────────────┬────────────────────────┐
│ 스코프  │          의미          │       저장 위치        │
├─────────┼────────────────────────┼────────────────────────┤
│ user    │ 모든 프로젝트에서 공유 │ ~/.claude/ 하위        │
├─────────┼────────────────────────┼────────────────────────┤
│ project │ 현재 프로젝트 내 공유  │ ./CLAUDE.md 관련       │
├─────────┼────────────────────────┼────────────────────────┤
│ local   │ 현재 로컬 환경만       │ ./CLAUDE.local.md 관련 │
└─────────┴────────────────────────┴────────────────────────┘

### v2.1.32 vs v2.1.33의 관계

- **v2.1.32** = "무엇을" — 자동 기록/회상 메커니즘 도입
- **v2.1.33** = "어디에" — 에이전트별로 저장 스코프를 세밀 제어

---

## 6. 메모리 관리 명령어

┌───────────┬─────────────────────────────────────────────┐
│  명령어   │                    용도                     │
├───────────┼─────────────────────────────────────────────┤
│ /memory   │ 에디터에서 CLAUDE.md 직접 편집              │
├───────────┼─────────────────────────────────────────────┤
│ /remember │ 세션 메모리 패턴을 CLAUDE.local.md로 승격   │
├───────────┼─────────────────────────────────────────────┤
│ /init     │ 프로젝트에 CLAUDE.md 자동 생성 (부트스트랩) │
├───────────┼─────────────────────────────────────────────┤
│ /compact  │ 컨텍스트 압축 (Session Memory 존재 시 즉시) │
├───────────┼─────────────────────────────────────────────┤
│ Ctrl+O    │ 현재 세션에 로드된 메모리 상세 확인         │
└───────────┴─────────────────────────────────────────────┘

---

## 7. 메모리 회상 타이밍 정리

### 세션 시작

```
세션 시작
  ├─ CLAUDE.md 계층 자동 로드 (cwd → 루트 재귀 탐색)
  ├─ MEMORY.md 시스템 프롬프트 주입 (200줄 제한)
  └─ Session Memory 회상 ("Recalled X memories")
```

### 세션 중

```
세션 중
  ├─ 하위 디렉토리 파일 접근 시 해당 CLAUDE.md 온디맨드 로드
  ├─ @import 참조 확장 (최대 5홉)
  ├─ 조건부 규칙 적용 (paths frontmatter 매칭 시)
  └─ 주기적 메모리 쓰기 ("Wrote X memories")
```

### 세션 종료

```
세션 종료
  └─ 세션 요약 최종 저장 → 다음 세션에서 회상 대상
```

---

## 8. 제한사항

- **Session Memory는 Anthropic First-party API (Pro/Max 구독) 사용자 대상**이며, Bedrock/Vertex/Foundry에서는 미지원
- 자동 메모리를 명시적으로 비활성화하는 설정은 공식 문서에 없음
- Auto Memory Directory의 `MEMORY.md`는 **200줄 제한**
- 서버 측 feature gate(`tengu_session_memory`)로 점진적 배포 중

---

## 9. 실전 팁

### MEMORY.md 작성 패턴

```markdown
# MEMORY.md

## 프로젝트 패턴
- 모든 API는 `/api/v1/` 프리픽스 사용
- 에러는 `ErrorResponse` 타입으로 통일

## 자주 하는 실수
- `UserService`는 싱글톤이므로 new 생성 금지
- 테스트에서 mock 데이터는 `fixtures/`에서만 import

## 링크
상세 아키텍처: architecture.md
코딩 스타일: style-guide.md
```

### /remember 사용 시나리오

```
3번째 세션에서 또 같은 eslint 규칙을 수정하고 있다면:

User: "/remember eslint에서 no-unused-vars를 warn으로 설정해줘"
Claude: [CLAUDE.local.md에 규칙 추가]
```

### Session Memory 확인

```bash
# 현재 세션의 메모리 위치 찾기
ls -la ~/.claude/projects/*/*/session-memory/summary.md

# 내용 확인
cat ~/.claude/projects/<project-encoded>/<session-id>/session-memory/summary.md
```

---

## 참고 문서

- https://code.claude.com/docs/en/memory
- https://code.claude.com/docs/en/settings
- https://platform.claude.com/docs/en/agents-and-tools/tool-use/memory-tool
- https://claudefa.st/blog/guide/mechanics/session-memory
