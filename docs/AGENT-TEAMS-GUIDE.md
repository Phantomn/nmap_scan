# Claude Code Agent Teams 종합 사용 가이드

## 1. 활성화

Agent Teams는 기본 비활성화 상태이며, 실험적 기능입니다.

```bash
# 방법 1: 환경변수
export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1

# 방법 2: settings.json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}

# 방법 3: 세션 단위
CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 claude
```

---

## 2. 아키텍처

```
┌─────────────────────────────────────────────┐
│  Team Lead (메인 Claude Code 세션)           │
│  - 팀 생성/정리, 태스크 할당, 결과 종합       │
├──────────┬──────────┬───────────────────────┤
│ Teammate │ Teammate │ Teammate              │
│ (독립적  │ (독립적  │ (독립적               │
│  컨텍스트)│  컨텍스트)│  컨텍스트)            │
├──────────┴──────────┴───────────────────────┤
│  Shared Task List + Mailbox                 │
└─────────────────────────────────────────────┘
```

┌───────────┬────────────────────────────────────────────────────────┐
│ 구성요소  │                          역할                          │
├───────────┼────────────────────────────────────────────────────────┤
│ Team Lead │ 팀 생성, 팀원 스폰, 태스크 할당, 결과 종합             │
├───────────┼────────────────────────────────────────────────────────┤
│ Teammates │ 독립적 Claude Code 인스턴스, 각자 고유 컨텍스트 윈도우 │
├───────────┼────────────────────────────────────────────────────────┤
│ Task List │ 모든 에이전트가 공유하는 작업 목록 (의존성 지원)       │
├───────────┼────────────────────────────────────────────────────────┤
│ Mailbox   │ 에이전트 간 비동기 메시징 시스템                       │
└───────────┴────────────────────────────────────────────────────────┘

### Subagent vs Teammate 차이

┌───────────────┬─────────────────────────┬─────────────────────────────┐
│     구분      │  Subagent (Task tool)   │          Teammate           │
├───────────────┼─────────────────────────┼─────────────────────────────┤
│ 수명          │ 단기, 결과 반환 후 종료 │ 지속적, 종료 요청까지 활성  │
├───────────────┼─────────────────────────┼─────────────────────────────┤
│ 태스크 리스트 │ 미공유                  │ 공유                        │
├───────────────┼─────────────────────────┼─────────────────────────────┤
│ 통신          │ 결과만 반환             │ 직접 메시지 교환 가능       │
├───────────────┼─────────────────────────┼─────────────────────────────┤
│ 적합 용도     │ 검색, 분석 등 단발성    │ 병렬 워크플로우, 파이프라인 │
└───────────────┴─────────────────────────┴─────────────────────────────┘

---

## 3. 팀 생성 (자연어)

활성화 후 자연어로 요청하면 됩니다:

```
PR #142를 리뷰하는 팀을 만들어주세요:
- 보안 영향 검토 1명
- 성능 영향 검토 1명
- 테스트 커버리지 검증 1명
각자 리뷰 후 결과를 보고하게 해주세요.
```

---

## 4. 에이전트 정의 파일

`.claude/agents/` 또는 `~/.claude/agents/`에 Markdown 파일로 정의합니다:

```markdown
---
name: security-reviewer
description: 코드 보안 취약점을 전문적으로 리뷰합니다
tools: Read, Glob, Grep, Bash
model: sonnet
memory: project
---

시니어 보안 리뷰어로서 다음을 확인하세요:
1. OWASP Top 10 취약점
2. 인증/인가 로직 검증
3. 입력 검증 누락 여부
```

### 프론트매터 필드

┌─────────────────┬────────────────────────────────────────┐
│      필드       │                  설명                  │
├─────────────────┼────────────────────────────────────────┤
│ name            │ 소문자+하이픈 고유 식별자              │
├─────────────────┼────────────────────────────────────────┤
│ description     │ 에이전트 역할 설명                     │
├─────────────────┼────────────────────────────────────────┤
│ tools           │ 허용 도구 목록 (allowlist)             │
├─────────────────┼────────────────────────────────────────┤
│ disallowedTools │ 거부 도구 목록 (denylist)              │
├─────────────────┼────────────────────────────────────────┤
│ model           │ sonnet, opus, haiku, inherit           │
├─────────────────┼────────────────────────────────────────┤
│ memory          │ (v2.1.33) user / project / local       │
├─────────────────┼────────────────────────────────────────┤
│ hooks           │ 라이프사이클 훅                        │
├─────────────────┼────────────────────────────────────────┤
│ permissionMode  │ default, acceptEdits, dontAsk, plan 등 │
└─────────────────┴────────────────────────────────────────┘

### 서브에이전트 제한 (v2.1.33)

```markdown
---
name: restricted-lead
tools: Read, Write, Edit, Task(security-reviewer), Task(performance-checker)
---
```

`Task(agent_type)` 구문으로 스폰 가능한 에이전트 종류를 제한할 수 있습니다.

---

## 5. 에이전트 간 통신

### 메시지 유형

┌───────────────────────┬───────────────────────────┬────────────────────┐
│         유형          │           설명            │        비용        │
├───────────────────────┼───────────────────────────┼────────────────────┤
│ write                 │ 특정 팀원에게 직접 메시지 │ 1x                 │
├───────────────────────┼───────────────────────────┼────────────────────┤
│ broadcast             │ 모든 팀원에게 동시 전송   │ N x (팀원 수 비례) │
├───────────────────────┼───────────────────────────┼────────────────────┤
│ idle_notification     │ 유휴 상태 자동 보고       │ 자동               │
├───────────────────────┼───────────────────────────┼────────────────────┤
│ plan_approval_request │ 계획 승인 요청            │ -                  │
├───────────────────────┼───────────────────────────┼────────────────────┤
│ shutdown_request      │ 종료 요청                 │ -                  │
└───────────────────────┴───────────────────────────┴────────────────────┘

### 사용자 직접 통신

- **In-process 모드**: Shift+Up/Down으로 팀원 선택, 타이핑으로 직접 메시지
- **Split-pane 모드**: 팀원 패널 클릭으로 해당 세션과 상호작용

---

## 6. 오케스트레이션 패턴

### Pattern 1: 병렬 전문가 (Parallel Specialists)

```
팀 리더 → 보안 전문가 + 성능 전문가 + 테스트 전문가
        → 각자 독립 수행 → 결과 종합
```

### Pattern 2: 파이프라인 (Pipeline)

```
Task #1 완료 (TaskCompleted)
  → Task #2 의존성 자동 해제
    → Task #2 수행 → Task #3 해제 → ...
```

### Pattern 3: Swarm (자기 조직화)

```
태스크 풀 → 팀원들이 자율적으로 클레임
          → 완료 시 TeammateIdle → 다음 태스크 자동 선택
```

### Pattern 4: 경쟁 가설 (Competing Hypotheses)

```
앱이 한 메시지 후 연결이 끊기는 문제가 있습니다.
5명의 팀원을 스폰해서 서로 다른 가설을 조사하게 하세요.
과학 토론처럼 서로의 이론을 반증하려 시도하세요.
```

### Delegate Mode

**Shift+Tab**을 누르면 리드가 조율 전용 모드로 전환됩니다. 직접 코드를 작성하지 않고 스폰, 메시징, 태스크 관리에만 집중합니다.

---

## 7. 태스크 관리

### 도구 및 상태 흐름

```
pending ──→ in_progress ──→ completed
                          ──→ deleted
```

┌────────────┬────────────────────────────────────────────────┐
│    도구    │                      기능                      │
├────────────┼────────────────────────────────────────────────┤
│ TaskCreate │ 태스크 생성 (subject, description, activeForm) │
├────────────┼────────────────────────────────────────────────┤
│ TaskUpdate │ 상태 변경, 소유자 설정, 의존성 추가            │
├────────────┼────────────────────────────────────────────────┤
│ TaskList   │ 전체 태스크 요약                               │
├────────────┼────────────────────────────────────────────────┤
│ TaskGet    │ 특정 태스크 상세 조회                          │
└────────────┴────────────────────────────────────────────────┘

### 의존성 자동 해제

```
Task #2: addBlockedBy: ["1"]
→ Task #1 완료 시 Task #2 자동 해제 (수동 개입 불필요)
```

---

## 8. 디스플레이 모드

### In-process (기본)

모든 팀원이 메인 터미널에서 실행. 추가 설정 불필요.

┌───────────────┬─────────────────────┐
│    단축키     │        기능         │
├───────────────┼─────────────────────┤
│ Shift+Up/Down │ 팀원 전환           │
├───────────────┼─────────────────────┤
│ Enter         │ 팀원 세션 전체 보기 │
├───────────────┼─────────────────────┤
│ Ctrl+T        │ 태스크 리스트 토글  │
├───────────────┼─────────────────────┤
│ Shift+Tab     │ Delegate 모드 전환  │
└───────────────┴─────────────────────┘

### Split Pane (tmux / iTerm2)

각 팀원이 별도 터미널 패널을 가집니다:

```json
// settings.json
{ "teammateMode": "tmux" }
```

```bash
# 또는 CLI
claude --teammate-mode tmux
```

**설정값**:
- `"auto"` (기본) — tmux 세션 내부면 split pane, 아니면 in-process
- `"tmux"` — split pane 강제
- `"in-process"` — in-process 강제

**주의**: VS Code 터미널, Windows Terminal, Ghostty는 미지원

---

## 9. 종료 및 정리

1. "researcher 팀원에게 종료를 요청해줘"  → 팀원 종료
2. 모든 팀원 종료 확인 후 "팀을 정리해줘" → cleanup 실행

**반드시 리드를 통해 정리해야 합니다.** 팀원이 직접 cleanup을 실행하면 리소스 불일치가 발생할 수 있습니다.

---

## 10. 비용 고려사항

┌────────────────┬───────────────────────────────────────┐
│      항목      │                 수치                  │
├────────────────┼───────────────────────────────────────┤
│ 일반 세션 평균 │ 개발자당 일 ~$6                       │
├────────────────┼───────────────────────────────────────┤
│ Agent Teams    │ 일반 대비 ~7배 토큰 소비              │
├────────────────┼───────────────────────────────────────┤
│ 팀원 5명       │ 단일 세션의 ~5배 (각자 독립 컨텍스트) │
└────────────────┴───────────────────────────────────────┘

### 최적화 전략

┌───────────────────────────────┬─────────────────────────┐
│             전략              │          효과           │
├───────────────────────────────┼─────────────────────────┤
│ 팀원 모델로 Sonnet/Haiku 사용 │ Opus 대비 대폭 절감     │
├───────────────────────────────┼─────────────────────────┤
│ 팀 규모 최소화                │ 토큰 = 팀원 수에 비례   │
├───────────────────────────────┼─────────────────────────┤
│ broadcast 대신 write 사용     │ broadcast는 N배 소비    │
├───────────────────────────────┼─────────────────────────┤
│ 작업 완료 후 즉시 정리        │ 유휴 팀원도 토큰 소비   │
├───────────────────────────────┼─────────────────────────┤
│ 팀원당 5~6개 태스크가 적정    │ 과도한 태스크 분할 방지 │
└───────────────────────────────┴─────────────────────────┘

---

## 11. 제한사항 요약

┌─────────────────┬───────────────────────────────────────────┐
│      제한       │                   상세                    │
├─────────────────┼───────────────────────────────────────────┤
│ 세션 복원 불가  │ /resume이 in-process 팀원을 복원하지 않음 │
├─────────────────┼───────────────────────────────────────────┤
│ 세션당 1개 팀   │ 동시에 하나의 팀만 관리 가능              │
├─────────────────┼───────────────────────────────────────────┤
│ 중첩 팀 불가    │ 팀원은 자체 팀/팀원 생성 불가             │
├─────────────────┼───────────────────────────────────────────┤
│ 리드 고정       │ 팀을 만든 세션이 영구 리드, 이전 불가     │
├─────────────────┼───────────────────────────────────────────┤
│ Split pane 환경 │ tmux 또는 iTerm2 필요                     │
├─────────────────┼───────────────────────────────────────────┤
│ 실험적 기능     │ 프로덕션 안정성 보장 없음                 │
└─────────────────┴───────────────────────────────────────────┘

---

## 참고 문서

- https://code.claude.com/docs/en/agent-teams
- https://code.claude.com/docs/en/sub-agents
- https://code.claude.com/docs/en/hooks
- https://code.claude.com/docs/en/costs
- https://www.marc0.dev/en/blog/claude-code-agent-teams-multiple-ai-agents-working-in-parallel-setup-guide-1770317684454
